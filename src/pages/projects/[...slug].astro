---
import type { CollectionEntry } from "astro:content";
import type { ImageMetadata } from "astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import BaseLayout from "@layouts/BaseLayout.astro";
import { ExternalLink, Github, ArrowLeft, Calendar, Folder } from "@lucide/astro";
import { getPublishedProjects, getProjectDateRange, isOngoing } from "@utils/projects";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects
    .filter((project) => !project.data.draft)
    .map((project) => ({
      params: { slug: project.slug },
      props: { project },
    }));
}

type Props = {
  project: CollectionEntry<"projects">;
};

const { project } = Astro.props;
const { Content, headings } = await project.render();

const { title, description, coverImage, techStack, category, liveUrl, repoUrl, status } = project.data;

const coverImg = coverImage as ImageMetadata | undefined;
const dateRange = getProjectDateRange(project);
const ongoing = isOngoing(project);

const statusConfig = {
  "in-progress": {
    label: "Currently working on",
    icon: "ðŸ”µ",
    class: "status-ongoing",
  },
  completed: { label: "Completed", icon: "âšª", class: "status-completed" },
  archived: { label: "Archived", icon: "ðŸ”´", class: "status-archived" },
  "on-hold": { label: "On Hold", icon: "ðŸŸ ", class: "status-on-hold" },
};

const currentStatus = statusConfig[status];

// Get all projects for navigation
const allProjects = await getCollection("projects");
const publishedProjects = getPublishedProjects(allProjects);
const currentIndex = publishedProjects.findIndex((p) => p.slug === project.slug);
const prevProject = currentIndex > 0 ? publishedProjects[currentIndex - 1] : null;
const nextProject = currentIndex < publishedProjects.length - 1 ? publishedProjects[currentIndex + 1] : null;
---

<BaseLayout pageTitle={title}>
  <div class="project-detail">
    <a href="/projects" class="back-link">
      <ArrowLeft size={18} />
      Back to Projects
    </a>

    <article class="project-article">
      {/* Cover Image */}
      {coverImg && <Image src={coverImg} alt={`Cover image for ${title}`} class="cover-image" />}

      <header class="project-header">
        <div class="header-top">
          {category && <span class="project-category">{category}</span>}
          <span class={`status-badge ${currentStatus.class}`}>
            <span class="status-icon">{currentStatus.icon}</span>
            {currentStatus.label}
          </span>
        </div>

        <h1 class="project-title">{title}</h1>

        {description && <p class="project-description">{description}</p>}

        <div class="project-meta">
          <span class="meta-item">
            <Calendar size={16} />
            {dateRange}
          </span>
        </div>

        <div class="tech-stack">
          {
            techStack.map((tech) => (
              <a href={`/projects?tech=${tech.toLowerCase().replace(/\s+/g, "-")}`} class="tech-badge">
                {tech}
              </a>
            ))
          }
        </div>

        <div class="project-links">
          {
            liveUrl && (
              <a href={liveUrl} target="_blank" rel="noopener noreferrer" class="project-link project-link-primary">
                <ExternalLink size={18} />
                View Live
              </a>
            )
          }
          {
            repoUrl && (
              <a href={repoUrl} target="_blank" rel="noopener noreferrer" class="project-link project-link-secondary">
                <Github size={18} />
                View Code
              </a>
            )
          }
        </div>
      </header>

      <div class="prose">
        <Content />
      </div>
    </article>

    {/* Project Navigation */}
    <nav class="project-nav">
      {
        prevProject ? (
          <a href={`/projects/${prevProject.slug}`} class="nav-link nav-prev">
            <span class="nav-label">Previous Project</span>
            <span class="nav-title">{prevProject.data.title}</span>
          </a>
        ) : (
          <div />
        )
      }
      {
        nextProject ? (
          <a href={`/projects/${nextProject.slug}`} class="nav-link nav-next">
            <span class="nav-label">Next Project</span>
            <span class="nav-title">{nextProject.data.title}</span>
          </a>
        ) : (
          <div />
        )
      }
    </nav>
  </div>
</BaseLayout>

<style>
  @reference "tailwindcss";

  .project-detail {
    @apply mx-auto max-w-6xl px-4 pb-8;
  }

  .back-link {
    @apply inline-flex items-center gap-2 mb-6 text-sm font-medium;
    color: var(--color-muted);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .back-link:hover {
    color: var(--color-accent);
  }

  .project-article {
    @apply rounded-xl overflow-hidden;
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
  }

  .cover-image {
    @apply w-full;
    max-height: 400px;
    object-fit: cover;
  }

  .cover-placeholder {
    @apply flex items-center justify-center;
    height: 300px;
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-hover) 100%);
    color: white;
    opacity: 0.7;
  }

  .project-header {
    @apply p-8 border-b border-(--color-border);
  }

  .header-top {
    @apply flex flex-wrap items-center gap-3 mb-4;
  }

  .project-category {
    @apply inline-flex items-center rounded-full px-3 py-1 text-xs font-medium uppercase tracking-wider;
    background-color: var(--color-bg);
    color: var(--color-muted);
    border: 1px solid var(--color-border);
  }

  .status-badge {
    @apply inline-flex items-center gap-1.5 text-xs font-medium;
    color: var(--color-muted);
  }

  .status-icon {
    font-size: 10px;
  }

  .status-ongoing {
    color: var(--color-accent);
  }

  .project-title {
    @apply text-3xl font-bold tracking-tight sm:text-4xl mb-4;
    font-family: var(--font-sans);
    color: var(--color-text);
  }

  .project-description {
    @apply text-lg mb-4;
    color: var(--color-muted);
    margin: 0 0 1rem;
  }

  .project-meta {
    @apply flex flex-wrap items-center gap-4 mb-4;
  }

  .meta-item {
    @apply flex items-center gap-2 text-sm;
    color: var(--color-muted);
  }

  .tech-stack {
    @apply flex flex-wrap gap-2 mb-6;
  }

  .tech-badge {
    @apply inline-flex items-center rounded-full px-3 py-1.5 text-sm font-medium;
    background-color: var(--color-bg);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    text-decoration: none;
    transition:
      border-color 0.2s ease,
      color 0.2s ease;
  }

  .tech-badge:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .project-links {
    @apply flex flex-wrap gap-3;
  }

  .project-link {
    @apply inline-flex items-center gap-2 rounded-lg px-5 py-2.5 text-sm font-medium;
    text-decoration: none;
    transition:
      background-color 0.2s ease,
      transform 0.2s ease;
  }

  .project-link:hover {
    transform: translateY(-2px);
  }

  .project-link-primary {
    background-color: var(--color-accent);
    color: white;
  }

  .project-link-primary:hover {
    background-color: var(--color-accent-hover);
  }

  .project-link-secondary {
    background-color: var(--color-bg);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .project-link-secondary:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .prose {
    @apply p-8;
  }

  /* Project Navigation */
  .project-nav {
    @apply grid grid-cols-2 gap-4 mt-8;
  }

  .nav-link {
    @apply flex flex-col gap-1 p-4 rounded-lg;
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    text-decoration: none;
    transition:
      border-color 0.2s ease,
      transform 0.2s ease;
  }

  .nav-link:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
  }

  .nav-prev {
    text-align: left;
  }

  .nav-next {
    text-align: right;
  }

  .nav-label {
    @apply text-xs uppercase tracking-wider;
    color: var(--color-muted);
  }

  .nav-title {
    @apply text-sm font-medium line-clamp-1;
    color: var(--color-text);
  }

  .nav-link:hover .nav-title {
    color: var(--color-accent);
  }
</style>
