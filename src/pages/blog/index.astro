---
import BaseLayout from "@layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import BlogCard from "@components/blog/BlogCard.astro";
import BlogCardHero from "@components/blog/BlogCardHero.astro";
import CategoryFilter from "@components/blog/CategoryFilter.astro";
import { collectUniqueCategory, normalizeCategory } from "@utils/category";
import { LayoutGrid, List } from "@lucide/astro";

const allPosts = await getCollection("blog");

// Filter drafts and sort by publishedAt descending
const posts = allPosts.filter((post) => !post.data.draft).sort((a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime());

// Get featured post (latest) and remaining posts
const [featuredPost, ...remainingPosts] = posts;

// Get categories with counts
const categories = collectUniqueCategory(posts);
const categoriesWithCount = categories
  .map((cat) => ({
    name: cat,
    count: posts.filter((p) => normalizeCategory(p.data.category) === normalizeCategory(cat)).length,
  }))
  .sort((a, b) => b.count - a.count);
---

<BaseLayout pageTitle="Blog">
  <div class="blog-index">
    {
      posts.length > 0 ? (
        <>
          {/* Category Filter */}
          <CategoryFilter categories={categoriesWithCount} totalCount={posts.length} />

          {/* View Toggle */}
          <div class="view-controls">
            <span class="view-label">View:</span>
            <button class="view-toggle active" data-view="grid" aria-label="Grid view">
              <LayoutGrid size={18} />
            </button>
            <button class="view-toggle" data-view="list" aria-label="List view">
              <List size={18} />
            </button>
          </div>

          {/* Featured Hero Post */}
          {featuredPost && (
            <div class="hero-wrapper" data-post-category={normalizeCategory(featuredPost.data.category)}>
              <span class="featured-label">Featured</span>
              <BlogCardHero post={featuredPost} />
            </div>
          )}

          {/* Posts Grid */}
          <div class="posts-section">
            <div class="posts-grid">
              {remainingPosts.map((post) => (
                <BlogCard post={post} />
              ))}
            </div>
          </div>
        </>
      ) : (
        <div class="empty-state">
          <p>No posts published yet. Check back soon!</p>
        </div>
      )
    }
  </div>
</BaseLayout>

<style>
  @reference "tailwindcss";

  .blog-index {
    @apply mx-auto max-w-6xl px-4 pb-12;
  }

  .blog-header {
    @apply mb-6 text-center;
  }

  .blog-header h1 {
    @apply mb-3 text-4xl font-bold md:text-5xl;
    font-family: var(--font-sans);
    color: var(--color-text);
  }

  .blog-subtitle {
    @apply text-lg md:text-xl;
    color: var(--color-muted);
  }

  .view-controls {
    @apply mb-6 flex items-center justify-end gap-2;
  }

  .view-label {
    @apply mr-1 text-sm;
    color: var(--color-muted);
  }

  .view-toggle {
    @apply flex cursor-pointer items-center justify-center rounded-lg border p-2;
    background-color: var(--color-surface);
    border-color: var(--color-border);
    color: var(--color-muted);
    transition:
      background-color 0.2s ease,
      border-color 0.2s ease,
      color 0.2s ease;
  }

  .view-toggle:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .view-toggle.active {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  .hero-wrapper {
    @apply relative mb-10;
    transition:
      opacity 0.3s ease,
      transform 0.3s ease;
  }

  .featured-label {
    @apply absolute -top-3 left-4 z-10 rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-wider;
    background-color: var(--color-accent);
    color: white;
  }

  .posts-section {
    @apply mt-8;
  }

  .posts-grid {
    @apply grid gap-6;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  }

  /* List View */
  .posts-grid.list-view {
    @apply flex flex-col gap-4;
  }

  .posts-grid.list-view > :global(.blog-card) {
    @apply flex-row;
  }

  .posts-grid.list-view > :global(.blog-card .card-link) {
    @apply grid grid-cols-[200px_1fr] gap-4 md:grid-cols-[280px_1fr];
  }

  .posts-grid.list-view > :global(.blog-card .card-image) {
    @apply aspect-4/3 h-full;
  }

  .posts-grid.list-view > :global(.blog-card .card-content) {
    @apply justify-center py-4;
  }

  .empty-state {
    @apply py-16 text-center;
    color: var(--color-muted);
  }
</style>

<script>
  function initBlogPage() {
    // View toggle functionality
    const viewToggles = document.querySelectorAll<HTMLButtonElement>(".view-toggle");
    const postsGrid = document.querySelector<HTMLElement>(".posts-grid");

    viewToggles.forEach((toggle) => {
      toggle.addEventListener("click", () => {
        const view = toggle.dataset.view;

        // Update active state
        viewToggles.forEach((t) => t.classList.remove("active"));
        toggle.classList.add("active");

        // Toggle view class
        if (postsGrid) {
          if (view === "list") {
            postsGrid.classList.add("list-view");
          } else {
            postsGrid.classList.remove("list-view");
          }
        }

        // Save preference
        localStorage.setItem("blog-view", view || "grid");
      });
    });

    // Restore view preference
    const savedView = localStorage.getItem("blog-view");
    if (savedView === "list" && postsGrid) {
      postsGrid.classList.add("list-view");
      viewToggles.forEach((t) => {
        t.classList.toggle("active", t.dataset.view === "list");
      });
    }
  }

  // Initialize on DOM ready
  document.addEventListener("DOMContentLoaded", initBlogPage);
  // Re-initialize on Astro page transitions
  document.addEventListener("astro:page-load", initBlogPage);
</script>
