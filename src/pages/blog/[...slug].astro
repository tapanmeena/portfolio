---
import type { CollectionEntry } from "astro:content";
import type { ImageMetadata } from "astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import BaseLayout from "@layouts/BaseLayout.astro";
import TableOfContent from "@components/blog/TableOfContent.astro";
import BlogMeta from "@components/blog/BlogMeta.astro";
import { calculateReadTime } from "@utils/readTime";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts
    .filter((post) => !post.data.draft)
    .map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
}

type Props = {
  post: CollectionEntry<"blog">;
};

const { post } = Astro.props;
const { Content, headings } = await post.render();

// Calculate read time from raw content
const readTime = calculateReadTime(post.body);
const coverImage = post.data.coverImage as ImageMetadata | undefined;
---

<BaseLayout pageTitle={post.data.title}>
  <div class="blog-layout">
    <!-- Main Content -->
    <article class="article-container">
      {/* Cover Image */}
      {coverImage && <Image src={coverImage} alt={`Cover image for ${post.data.title}`} class="cover-image" />}

      <header class="article-header">
        <h1 class="article-title">{post.data.title}</h1>
        {post.data.description && <p class="article-description">{post.data.description}</p>}
        <BlogMeta
          author={post.data.author}
          publishedAt={post.data.publishedAt}
          updatedAt={post.data.updatedAt}
          category={post.data.category}
          tags={post.data.tags}
          readTime={readTime}
        />
      </header>
      <div class="prose">
        <Content />
      </div>
    </article>

    <!-- Right Sidebar: TOC -->
    <aside class="toc-sidebar">
      <TableOfContent headings={headings} />
    </aside>
  </div>
</BaseLayout>

<style>
  @reference "tailwindcss";

  /* 2-column grid layout */
  .blog-layout {
    @apply mx-auto max-w-6xl px-4 py-8 sm:px-6 lg:px-8;
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  @media (min-width: 1024px) {
    .blog-layout {
      grid-template-columns: 1fr 240px;
      gap: 3rem;
      align-items: start;
    }
  }

  /* TOC Sidebar */
  .toc-sidebar {
    @apply hidden lg:block;
    position: sticky;
    top: 6rem;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .toc-sidebar::-webkit-scrollbar {
    display: none;
  }

  /* Article container */
  .article-container {
    @apply w-full;
  }

  /* Cover Image */
  .cover-image {
    @apply w-full rounded-xl mb-8;
    max-height: 400px;
    object-fit: cover;
  }

  .article-header {
    @apply mb-8 border-b border-(--color-border) pb-8;
  }

  .article-title {
    @apply text-3xl font-bold tracking-tight sm:text-4xl;
    font-family: var(--font-sans);
    color: var(--color-text);
  }

  .article-description {
    @apply mt-4 text-lg;
    color: var(--color-muted);
  }
</style>
