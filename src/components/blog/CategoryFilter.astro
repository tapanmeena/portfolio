---
import { normalizeCategory } from "@utils/category";

interface CategoryData {
  name: string;
  count: number;
}

interface Props {
  categories: CategoryData[];
  totalCount: number;
}

const { categories, totalCount } = Astro.props;
---

<div class="category-filter-wrapper">
  <nav class="category-filter" data-animate="filter">
    <button class="filter-pill active" data-category="all">
      All
      <span class="pill-count">{totalCount}</span>
    </button>
    {
      categories.map(({ name, count }) => (
        <button class="filter-pill" data-category={normalizeCategory(name)} data-original={name}>
          {name}
          <span class="pill-count">{count}</span>
        </button>
      ))
    }
  </nav>
</div>

<style>
  @reference "tailwindcss";

  .category-filter-wrapper {
    @apply sticky top-16 z-40 -mx-4 mb-8 overflow-hidden px-4 md:top-20;
  }

  .category-filter {
    @apply flex gap-2 overflow-x-auto py-4;
  }

  .filter-pill {
    @apply inline-flex shrink-0 cursor-pointer items-center gap-2 rounded-full border px-4 py-2 text-sm font-medium;
    background-color: var(--color-surface);
    border-color: var(--color-border);
    color: var(--color-text);
    transition:
      background-color 0.5s ease,
      border-color 0.5s ease,
      color 0.5s ease,
      transform 0.5s ease;
  }

  .filter-pill:hover {
    border-color: var(--color-accent);
    transform: translateY(-1px);
  }

  .filter-pill.active {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  .filter-pill.active .pill-count {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
  }

  .pill-count {
    @apply rounded-full px-2 py-0.5 text-xs;
    background-color: var(--color-bg);
    color: var(--color-muted);
    transition:
      background-color 0.5s ease,
      color 0.5s ease;
  }
</style>

<script>
  function initCategoryFilter() {
    const filterNav = document.querySelector(".category-filter");
    const pills = document.querySelectorAll<HTMLButtonElement>(".filter-pill");
    const postCards = document.querySelectorAll<HTMLElement>("[data-post-category]");

    if (!filterNav || pills.length === 0) return;

    pills.forEach((pill) => {
      pill.addEventListener("click", () => {
        const category = pill.dataset.category;

        // Update active state
        pills.forEach((p) => p.classList.remove("active"));
        pill.classList.add("active");

        // Filter posts with CSS transitions
        postCards.forEach((card) => {
          const cardCategory = card.dataset.postCategory;
          const shouldShow = category === "all" || cardCategory === category;

          if (shouldShow) {
            card.style.display = "";
            card.style.opacity = "0";
            card.style.transform = "scale(0.95)";
            // Trigger reflow for animation
            void card.offsetHeight;
            card.style.opacity = "1";
            card.style.transform = "scale(1)";
          } else {
            card.style.opacity = "0";
            card.style.transform = "scale(0.95)";
            setTimeout(() => {
              card.style.display = "none";
            }, 200);
          }
        });

        // Handle hero card visibility
        const heroWrapper = document.querySelector<HTMLElement>(".hero-wrapper");
        if (heroWrapper) {
          const heroCategory = heroWrapper.getAttribute("data-post-category");
          const shouldShowHero = category === "all" || heroCategory === category;

          if (shouldShowHero) {
            heroWrapper.style.display = "";
            heroWrapper.style.opacity = "0";
            heroWrapper.style.transform = "translateY(-20px)";
            // Trigger reflow for animation
            void heroWrapper.offsetHeight;
            heroWrapper.style.opacity = "1";
            heroWrapper.style.transform = "translateY(0)";
          } else {
            heroWrapper.style.opacity = "0";
            heroWrapper.style.transform = "translateY(-20px)";
            setTimeout(() => {
              heroWrapper.style.display = "none";
            }, 200);
          }
        }
      });
    });
  }

  // Initialize on DOM ready
  document.addEventListener("DOMContentLoaded", initCategoryFilter);
  // Re-initialize on Astro page transitions
  document.addEventListener("astro:page-load", initCategoryFilter);
</script>
