---
import type { CollectionEntry } from "astro:content";
import type { ImageMetadata } from "astro";
import { Image } from "astro:assets";
import { Calendar, Clock, Folder, Tag, RefreshCw } from "@lucide/astro";
import { calculateReadTime, formatReadTime } from "@utils/readTime";
import { categoryToUrl, normalizeCategory } from "@utils/category";
import { tagToUrl } from "@utils/tags";
import { getAuthorByName } from "@data/authors";

interface Props {
  post: CollectionEntry<"blog">;
}

const { post } = Astro.props;
const { title, description, publishedAt, updatedAt, category, tags, coverImage, author } = post.data;

const readTime = calculateReadTime(post.body);
const imageSrc = coverImage as ImageMetadata | undefined;
const authorData = getAuthorByName(author);
const wasUpdated = updatedAt && updatedAt > publishedAt;

const formattedDate = publishedAt.toLocaleDateString("en-US", {
  year: "numeric",
  month: "short",
  day: "numeric",
});
---

<article class="blog-card" data-post-category={normalizeCategory(category)}>
  <a href={`/blog/${post.slug}`} class="card-link">
    <div class="card-image">
      {
        imageSrc ? (
          <Image src={imageSrc} alt={`Cover image for ${title}`} class="cover-img" width={400} height={225} />
        ) : (
          <div class="cover-placeholder">
            <Folder size={32} />
          </div>
        )
      }
      {
        wasUpdated && (
          <span class="updated-badge">
            <RefreshCw size={12} />
            Updated
          </span>
        )
      }
    </div>
    <div class="card-content">
      <div class="card-meta">
        <span class="meta-item">
          <Calendar size={14} />
          <time datetime={publishedAt.toISOString()}>{formattedDate}</time>
        </span>
        <span class="meta-item">
          <Clock size={14} />
          <span>{formatReadTime(readTime)}</span>
        </span>
      </div>

      <h3 class="card-title">{title}</h3>

      {description && <p class="card-description">{description}</p>}

      <div class="card-footer">
        <div class="card-author">
          <img src={authorData.avatar} alt={authorData.name} class="author-avatar" onerror="this.src='/images/authors/default.svg'" />
          <span class="author-name">{authorData.name}</span>
        </div>

        <span class="category-badge">
          {category}
        </span>
      </div>
    </div>
  </a>
</article>

<style>
  @reference "tailwindcss";

  .blog-card {
    @apply overflow-hidden rounded-xl;
    background-color: var(--color-surface);
    border: 1px solid var(--color-border);
    transition:
      transform 0.3s ease,
      box-shadow 0.3s ease,
      border-color 0.3s ease,
      opacity 0.3s ease;
  }

  .blog-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 16px 32px -8px rgba(0, 0, 0, 0.12);
    border-color: var(--color-accent);
  }

  :global(.dark) .blog-card:hover {
    box-shadow: 0 16px 32px -8px rgba(0, 0, 0, 0.4);
  }

  .card-link {
    @apply block no-underline;
    color: inherit;
  }

  .card-image {
    @apply relative aspect-video w-full overflow-hidden;
    background-color: var(--color-bg);
  }

  .cover-img {
    @apply h-full w-full object-cover;
    transition: transform 0.4s ease;
  }

  :global(.dark) .cover-img {
    filter: brightness(0.9);
  }

  :global(.dark) .blog-card:hover .cover-img {
    filter: brightness(1);
  }

  .blog-card:hover .cover-img {
    transform: scale(1.05);
  }

  .cover-placeholder {
    @apply flex h-full w-full items-center justify-center;
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-hover) 100%);
    color: white;
    opacity: 0.7;
  }

  .updated-badge {
    @apply absolute right-3 top-3 flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    backdrop-filter: blur(4px);
  }

  .card-content {
    @apply flex flex-col gap-3 p-5;
  }

  .card-meta {
    @apply flex flex-wrap items-center gap-3 text-xs;
    color: var(--color-muted);
  }

  .meta-item {
    @apply flex items-center gap-1;
  }

  .card-title {
    @apply line-clamp-2 text-lg font-semibold leading-tight;
    font-family: var(--font-sans);
    color: var(--color-text);
    margin: 0;
    transition: color 0.2s ease;
  }

  .blog-card:hover .card-title {
    color: var(--color-accent);
  }

  .card-description {
    @apply line-clamp-2 text-sm leading-relaxed;
    color: var(--color-muted);
    margin: 0;
  }

  .card-footer {
    @apply flex items-center justify-between gap-3 pt-2;
  }

  .card-author {
    @apply flex items-center gap-2;
  }

  .author-avatar {
    @apply h-7 w-7 rounded-full object-cover;
    border: 1.5px solid var(--color-border);
  }

  .author-name {
    @apply text-xs font-medium;
    color: var(--color-text);
  }

  .category-badge {
    @apply inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-medium;
    background-color: var(--color-accent);
    color: white;
  }
</style>
