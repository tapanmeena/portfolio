---
import { List } from "@lucide/astro";

interface Props {
  headings: { depth: number; slug: string; text: string }[];
  title?: string;
  Icon?: astroHTML.JSX.Element;
}

const { headings, title = "Table of Contents", Icon } = Astro.props;

// Filter to show only h1, h2 and h3
const tocHeadings = headings.filter((h) => h.depth >= 1 && h.depth <= 3);
---

{
  tocHeadings.length > 0 && (
    <nav class="toc-container" aria-label="Table of contents">
      {/* Progress bar */}
      <div class="toc-progress-track">
        <div class="toc-progress-bar" id="toc-progress" />
      </div>

      {/* Title */}
      <div class="toc-header">
        <slot name="icon">
          <List size={16} class="toc-icon" />
        </slot>
        <span class="toc-title">{title}</span>
      </div>

      {/* Links */}
      <ul class="toc-list">
        {tocHeadings.map((heading) => (
          <li class={`toc-item toc-depth-${heading.depth}`}>
            <a href={`#${heading.slug}`} class="toc-link" data-slug={heading.slug}>
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )
}

<script>
  function initTOC() {
    const tocLinks = document.querySelectorAll<HTMLAnchorElement>(".toc-link");
    const progressBar = document.getElementById("toc-progress");
    const article = document.querySelector("article");

    if (!tocLinks.length || !progressBar || !article) return;

    // Get all heading elements that match our TOC
    const headingSlugs = Array.from(tocLinks).map((link) => link.dataset.slug);
    const headingElements = headingSlugs.map((slug) => document.getElementById(slug!)).filter(Boolean) as HTMLElement[];

    if (!headingElements.length) return;

    // Track active heading
    let activeSlug: string | null = null;

    const updateActiveLink = (slug: string | null) => {
      if (slug === activeSlug) return;
      activeSlug = slug;

      tocLinks.forEach((link) => {
        const isActive = link.dataset.slug === slug;
        link.classList.toggle("active", isActive);
      });
    };

    // Find the current active heading based on scroll position
    const findActiveHeading = () => {
      const scrollTop = window.scrollY;
      const offset = 100; // Account for header height

      // Find the last heading that has scrolled past the offset
      let currentHeading: HTMLElement | null = null;

      for (const heading of headingElements) {
        const headingTop = heading.getBoundingClientRect().top + scrollTop;
        if (headingTop <= scrollTop + offset) {
          currentHeading = heading;
        } else {
          break;
        }
      }

      // If no heading has scrolled past, use the first one if we're near the top
      if (!currentHeading && scrollTop < 200) {
        currentHeading = headingElements[0];
      }

      if (currentHeading) {
        updateActiveLink(currentHeading.id);
      }
    };

    // Update progress bar based on article scroll position
    const updateProgress = () => {
      const articleRect = article.getBoundingClientRect();
      const articleTop = articleRect.top + window.scrollY;
      const articleHeight = article.offsetHeight;
      const windowHeight = window.innerHeight;

      // Calculate how much of the article has been scrolled
      const scrolled = window.scrollY - articleTop + windowHeight * 0.3;
      const progress = Math.min(100, Math.max(0, (scrolled / articleHeight) * 100));

      progressBar.style.height = `${progress}%`;
    };

    // Combined scroll handler
    const onScroll = () => {
      findActiveHeading();
      updateProgress();
    };

    window.addEventListener("scroll", onScroll, { passive: true });

    // Initial call to set active heading on page load
    findActiveHeading();
    updateProgress();

    // Cleanup on page navigation (for Astro view transitions)
    document.addEventListener("astro:before-swap", () => {
      window.removeEventListener("scroll", onScroll);
    });
  }

  // Initialize on page load
  initTOC();

  // Re-initialize after Astro view transitions
  document.addEventListener("astro:after-swap", initTOC);
</script>

<style>
  @reference "tailwindcss";

  .toc-container {
    @apply hidden lg:block;
    padding-left: 1rem;
    position: relative;
  }

  /* Progress track (background line) */
  .toc-progress-track {
    @apply absolute left-0 top-0 bottom-0 w-0.5;
    background-color: var(--color-border);
  }

  /* Progress bar (growing fill) */
  .toc-progress-bar {
    @apply absolute left-0 top-0 w-0.5;
    background-color: var(--color-accent);
    height: 0%;
    transition: height 0.1s ease-out;
  }

  /* Header */
  .toc-header {
    @apply flex items-center gap-2 mb-4 pb-2;
    border-bottom: 1px solid var(--color-border);
  }

  .toc-icon {
    color: var(--color-accent);
    flex-shrink: 0;
  }

  .toc-title {
    @apply text-sm font-semibold;
    color: var(--color-text);
  }

  /* List */
  .toc-list {
    @apply space-y-1;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    @apply leading-snug;
  }

  /* Indentation based on depth */
  .toc-depth-1 {
    @apply pl-0;
  }

  .toc-depth-1 .toc-link {
    @apply font-medium;
  }

  .toc-depth-2 {
    @apply pl-3;
  }

  .toc-depth-3 {
    @apply pl-6 text-xs;
  }

  .toc-depth-3 .toc-link {
    @apply py-1;
  }

  /* Links */
  .toc-link {
    @apply block py-1.5 text-sm no-underline rounded-sm;
    color: var(--color-muted);
    transition:
      color 0.2s ease,
      background-color 0.2s ease,
      padding-left 0.2s ease;
  }

  .toc-link:hover {
    color: var(--color-text);
  }

  .toc-link.active {
    color: var(--color-accent);
    font-weight: 500;
    padding-left: 0.5rem;
  }
</style>
